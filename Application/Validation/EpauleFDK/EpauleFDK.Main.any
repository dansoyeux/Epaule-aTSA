#include "../libdef.any"

// Find a detailed description of the model here

//TO MODIFY
#include "Model/Description.any"

Main = {
  
  //File to change before each simulation 
  #include "Input/InputVariables.any"
  
  //Definition of the CSA variation cases (glenoid rotation and acromion length)
  #include "Model/CSAVariation.any"
  
  //Places a glenoid and a humeral implant
  #if BallAndSocket == 0
  #include "Model/Implants.any"  
  #endif // #if BallAndSocket
  
  #include "Model/BodyModelSettings.any"
  
  // Morphes the scapula to make the acromion longer
  #include "Scaling/ScalingCustom.any"
  
  #include "<ANYBODY_PATH_BODY>/HumanModel.any"    
  
  AnyFolder Model = {
    
    AnyFolder &BodyModel=.HumanModel.BodyModel;
    AnyFolder &MannequinDrivers = .HumanModel.DefaultMannequinDrivers;
    
    // Definition of the model environment
    #include "Model/Environment.any"
    
    AnyFolder ModelEnvironmentConnection = {
      #include "Model/JointsAndDrivers.any"
      
      // Additional reactions which are required to run the inverse dynamics analysis with the pelvis-ground interface used
      #include "Model\Reactions.any"
      
    }; // ModelEnvironmentConnection    
    
  }; // Model
  
  // Shortcuts
  AnyFolder &Jnt = Main.HumanModel.BodyModel.Right.ShoulderArm.Jnt;
  AnyFolder &Seg = Main.HumanModel.BodyModel.Right.ShoulderArm.Seg;
  AnyFolder &Mus = Main.HumanModel.BodyModel.Right.ShoulderArm.Mus;
  
  AnyBodyStudy Study = {
    
    // Shortcuts
    AnyFolder &Model = .Model;
    AnyFolder &Jnt = Model.BodyModel.Right.ShoulderArm.Jnt;
    AnyFolder &Seg = Model.BodyModel.Right.ShoulderArm.Seg;
    AnyFolder &Mus = Model.BodyModel.Right.ShoulderArm.Mus;
    
    // File to create a video from a loaded .h5 file
    #include "Output/MyCamera.any"
    
    // Evaluates the arm muscles moment arms
    #include "Model/EvaluateAbductionMomentArm.any"
    
    // Operation to run
    #include "Output/RunApplication.any"
    
    // Replaces the GlenoHumeral BallAndSocket joint with a 5 DOF FDK driven joint
    #include "Model/GHJointExchange.any"
    
    #if BallAndSocket == 0    
    //Adds contact between the shoulder implants
    #include "Model/ContactForces.any"
    
    // FDK parameters   
    InverseDynamics.ForceDepKinOnOff=On;
    InverseDynamics.ForceDepKin.MaxIteration=50;
    
    AnyOutputFun ForceDepKinError = {
      Val = Main.Study.InverseDynamics.ForceDepKinError;
    };
    #endif
    
    #if BallAndSocket == 1
    // Output variables collecting the GH forces in the pertinent coordinate frame
    AnyVec3 GHReactionInHumerus = -(Model.BodyModel.Right.ShoulderArm.Seg.Humerus.gh.Bergmann.Axes'
    *Model.BodyModel.Right.ShoulderArm.Jnt.GHReactions.ResultanForce.FTotalGlobal')';
    #endif
    
    Gravity = {0.01, -9.81, 0.01};
    
    tEnd = DesignVar(120.0);
    
    //   Small abduction (15 deg --> 15.5)
    #if SmallAbductionOn == 1
    nStep = 1;
    
    // Full abduction (15 deg --> 120deg)
    #else
    nStep = 70;
    #endif
    
    // Type de recrutement musculaire
    InverseDynamics.Criterion.Type= MuscleRecruitmentType;
    
    // Mesure of abduction angle (GH angle mesure is xzy)
    AnyVar rot = Main.HumanModel.BodyModel.Interface.Right.GlenohumeralAbduction.Pos[0]; // Total Abduction angle [rad]
    AnyVar rotD= rot*180/pi; // Total Abduction angle [deg]
    
    // Creates the .txt output file name
    // Check that file does not exist, otherwise makes a new file with a number at the end of its name (i.e. NameFile_#filenumber.txt)
    #include "Output/Output_CheckName.any"
    AnyString OutputFileName = get_filename({ANYBODY_PATH_OUTPUT + m_ResultFolder + m_ResultFile},{"txt"});
    
    // Creates a txt file containing the important variables to save and the input variables
    #if AnyOutputFileOn == 1
    #if BallAndSocket ==0
    #include "Output/Output_File_FDK.any"
    #else
    #include "Output/Output_File_BallAndSocket.any"
    #endif
    #endif
    
  }; // End of study
  
}; //Main














